---
title: "04APR22_RR"
author: "Sophie Belman"
date: "04/04/2022"
output: html_document
---

```{r}
library(data.table)
library(dplyr)
library(readxl)
library(ggplot2)
library(geodist)
library(ape)
library(BactDating)
```
### set variables
```{r}
sub=FALSE
disease=FALSE
```

##### Load in all GPS Data and subset GPS_SA >2000
```{r}
# GPS Data from the DataViewer
GPS <- read.table(file = "/Users/sb62/Documents/Migration/raw_data/combined_GPSPneumoDB_clean.csv", sep =  "," , header = TRUE, fill = TRUE, stringsAsFactors = FALSE)
# published<-read.csv("/Users/sb62/Documents/Migration/SA_Migration_110422/Relative_Risk_Framework/laneids-published.csv")
# pub_lid<-published$Lane_id[which(published$Published=="Y" | published$Published=="Others")]
# GPS<-subset(GPS,GPS$Lane_Id%in%pub_lid)
GPS_SA <- subset(GPS, GPS$Country == "South Africa")
GPS_SA$Region <- as.character(GPS_SA$Region)
GPS_SA$Region[GPS_SA$Region == "Kwazulu Natal"] <- "KwaZulu-Natal"
GPS_SA$Region[GPS_SA$Region == "KwaZulu Natal"] <- "KwaZulu-Natal"
GPS_SA$Region[GPS_SA$Region == "Soweto"] <- "Gauteng"
GPS_SA$Region[is.na(GPS_SA$Region)] <- "South Africa"
GPS_SA$Region[GPS_SA$Region == "Agincourt"] <- "Mpumalanga"
GPS_SA$Region[GPS_SA$Region == "North West"] <- "North West"
GPS_SA$Region[GPS_SA$Region == ""] <- "South Africa"
GPS_SA$Region[is.na(GPS_SA$Region)] <- "South Africa"
GPS_SA <- subset(GPS_SA, GPS_SA$Region != "South Africa")
GPS_SA[] <- lapply(GPS_SA, function(x) if(is.factor(x)) factor(x) else x)
GPS_SA<-subset(GPS_SA, GPS_SA$Col_Year>1999)
```
##### 1) RR Lineage Level: Find Latitude and Longitude for each province
```{r}
# #Specify that it is south africa so that it assigns the correct lat and long
GPS_SA$Region[GPS_SA$Region == "North West"] <- "North West, South Africa"
# # ##Province Latitude and longitude
city <- names(table(GPS_SA$Region[GPS_SA$Country=="South Africa"]))
#Geocoding
# #input is a list of country in a csv file
require(tmaptools)
# #output file
Geocoding_output <- data.frame("Region" =0, "Latitude_New"=0, "Longitude_New"=0)
# #Geocoding
for (i in city) {
  longitude <- geocode_OSM(i)$coords[1]
  latitude <- geocode_OSM(i)$coords[2]
  Geocoding_output <- rbind(Geocoding_output, c(i,latitude, longitude))
}
Geocoding_output <- subset(Geocoding_output, Geocoding_output$Longitude_New != 0)
GPS_GEO <- left_join(GPS_SA, Geocoding_output, by = "Region")
# # #Change it back to the name of the province once latitude is assigned
GPS_SA <- GPS_GEO
GPS_SA$Region[GPS_SA$Region == "North West, South Africa"] <- "North West"
# setwd("/Users/sb62/Documents/Migration/Mobility_transmission_SA/Mobility_transmission/04APR22_PlotScripts/Relative_Risk_Framework/inputFiles/")
# setwd("/Users/sb62/Documents/Migration/SA_Migration_110422/SA_Metadata/GPS/")
# save(GPS_SA,file="/Users/sb62/Documents/Migration/SA_Migration_110422/SA_Metadata/GPS/GPS_SA.RData")
# load("/Users/sb62/Documents/Migration/Mobility_transmission_SA/Mobility_transmission/04APR22_PlotScripts/Relative_Risk_Framework/GPS_SA.RData")
# GPS_SA<-subset(GPS_SA, GPS_SA$Type=="Disease")
```
#### Set up 6910X6910 Matrices for lineage level RR
```{r}
### Distance Matrix
vec_coords = cbind(as.numeric(GPS_SA$Longitude_New), as.numeric(GPS_SA$Latitude_New))
geo_mat_diff= geodist(
  vec_coords,
  vec_coords,
  paired=FALSE,
  measure="haversine")/1000
geo_mat_diff <- round(geo_mat_diff, 2)
diag(geo_mat_diff) <- NA
geo_mat_diff[geo_mat_diff==0] <- 10
colnames(geo_mat_diff) <-  GPS_SA$Region
rownames(geo_mat_diff) <-  GPS_SA$Region
lane.names <- GPS_SA$Lane_Id
# #GPSC similarity matrix
vector_gpsc <- GPS_SA$GPSC
strain_mat <- outer(vector_gpsc,vector_gpsc, "==")
diag(strain_mat) <- NA
strain_mat <- strain_mat + 0
rownames(strain_mat) <- lane.names
colnames(strain_mat) <- lane.names
# #VECTOR TYPE TO SUBSET BY DISEASE OR CARRIAGE LATER
vector_type <- GPS_SA$Type
#Exact collection years
vector_colyear <- GPS_SA$Col_time 
colyear_mat = abs(outer(vector_colyear, vector_colyear, "-"))
rownames(colyear_mat) <- lane.names
colnames(colyear_mat) <- lane.names
diag(colyear_mat) <- NA
```
####RR Function for Lineage Level RR
```{r}
neighbor_cont_bootstrap <- function(x=x,y=x, geo_matrix, colyear_matrix, strain_matrix){

  geo_mat.tmp = geo_matrix[x,y]
  time_mat.tmp = colyear_matrix[x,y]
  strain_mat.tmp = strain_matrix[x,y]
  
  tmp = (geo_mat.tmp)* time_mat.tmp 

  tmp[which(tmp==0)]<-NA
  # tmp2 = geo_mat.tmp*((geo_mat.tmp>1000)*( geo_mat.tmp<=1300)) * time_mat.tmp
  tmp2 = geo_mat.tmp*((geo_mat.tmp>1000)*( geo_mat.tmp<1600)) * time_mat.tmp
  tmp2[which(tmp2==0)]<-NA
  
  a1=cumsum(hist(tmp*strain_mat.tmp,breaks=c(0,0,minpos,1e10),plot=F)$counts)
  a2=cumsum(hist(tmp*strain_mat.tmp,breaks=c(0,0,maxpos,1e10),plot=F)$counts)
  a=a2-a1
  
  b1=cumsum(hist(tmp*(1-strain_mat.tmp),breaks=c(0,0,minpos,1e10),plot=F)$counts)
  b2=cumsum(hist(tmp*(1-strain_mat.tmp),breaks=c(0,0,maxpos,1e10),plot=F)$counts)
  b=b2-b1
  
  c = rep(sum(tmp2*strain_mat.tmp, na.rm=T),length(b))
  d = rep(sum(tmp2*(1-strain_mat.tmp), na.rm=T),length(a))
  
  rr = (a/b)/(c/d) 
  if (max(rr, na.rm = T)>1E10){
    rr = ((a+1)/(b+1))/((c+1)/(d+1)) 
  }
  if (min(rr, na.rm=T)==0){
    rr = ((a+1)/(b+1))/((c+1)/(d+1)) 
  }
  rr = rr[2:(length(rr)-1)]
  return(rr)
}
```
###### Calculate the RR at the lineage level across South African Provinces
```{r}
##collection time window
tseqmax=c(1)
tseqmin=c(0)
##set all variables
    strain_matrix = strain_mat
    geo_matrix = geo_mat_diff
    colyear_matrix = (colyear_mat>0)*(colyear_mat<=1)
##distance windows
    # window= c(300,400,500,300,300)
    # maxpos = c(100,500,1000,1300,1600)
    window= c(300,400,500,600)
    maxpos = c(100,500,1000,1600)
    minpos=maxpos-window
    minpos[which(minpos<0)]<-0
    minpos[1] <- 0
    nboot=50
    boot.out = matrix(NA, length(maxpos), nboot )
    nseq = nrow(GPS_SA)
    sa_row <- 1:nseq
    region_vec <- names(table(GPS_SA$Region))
    vector_region <- GPS_SA$Region
    # sub=FALSE
    for (j in 1:(nboot)){
      if(sub==TRUE){
      ######## Sample 300 per region
      selectedSeqs<-NULL
      for (i in 1:length(region_vec)){
      a <- which(vector_region==region_vec[i])
      b <- sample(a,min(300,length(a)),replace=T)
      selectedSeqs <- c(selectedSeqs,b)
      tmp = selectedSeqs
    } } else 
      #### Sample All#
      { tmp = sample(nseq, replace = T)} 
      rr =neighbor_cont_bootstrap(x=1:nseq,y=tmp,geo_matrix=geo_matrix, colyear_matrix=colyear_matrix, strain_matrix=strain_matrix)
      boot.out[,j] = rr
      # print(j)
      print(paste0("Lineage Level:",j,"/",nboot))
    }
    boot.ci = apply(boot.out[,(1:(nboot))], 1, quantile, probs = c(0.025,0.975), na.rm = T) 
    boot.ci.m = apply(boot.out[,(1:(nboot))], 1, quantile, probs = c(0.5), na.rm = T) 
    mat <- matrix(nrow=length(maxpos), ncol = 6)
    ## Matrix
    mat[,1] <- paste(minpos,"-",maxpos)
    mat[,2] <- boot.ci.m
    mat[,3] <- boot.ci[1,]
    mat[,4] <- boot.ci[2,]
    mat[,5] <- "0 - 1"
    mat[,6] <- minpos
    colnames(mat) <- c("distance_range" , "RR", "lowerCI", "upperCI", "time_range", "minimum_dist")
    mat <- as.data.table(mat)
    mat$RR <- as.numeric(mat$RR)
    mat$lowerCI <- as.numeric(mat$lowerCI)
    mat$upperCI <- as.numeric(mat$upperCI)
    mat$minimum_dist <- as.numeric(mat$minimum_dist)
    mat$distance_range[mat$distance_range=="0 - 100"]<-"Within Province"
    mat$distance_range[mat$distance_range=="100 - 500"]<-"<500"
    mat$distance_range[mat$distance_range=="500 - 1000"]<-"500-1000"
    mat$distance_range[mat$distance_range=="1000 - 1600"]<-"Distant Pairs"
    # mat$distance_range[mat$distance_range=="1300 - 1600"]<-">1300"
    mat_lineage<-mat
  
setwd("/Users/sb62/Documents/Migration/Mobility_transmission_SA/Mobility_transmission/04APR22_PlotScripts/Relative_Risk_Framework/input_files/")
    # if(disease==TRUE){ 
# if(sub==TRUE){save(mat_lineage,file="mat_lineage.disease.Sub.Rdata")} else {save(mat_lineage,file="mat_lineage.disease.noSub.Rdata") } } else{if(sub==TRUE){save(mat_lineage,file="mat_lineage.Sub.Rdata")} else {save(mat_lineage,file="mat_lineage.noSub.Rdata") } }
```

##### (2) Find RR using Genomic data(using time resolved trees) 
```{r}
# #Read in trees
resbd <- readRDS("/Users/sb62/Documents/Migration/BactDating/GPSC2/bactdating/bd_GPSC2_1e6")
res2 <- resbd$tree
resbd <- readRDS("/Users/sb62/Documents/Migration/BactDating/GPSC5/bactdating/bd_GPSC5_1e7")
res5 <- resbd$tree
resbd <- readRDS("/Users/sb62/Documents/Migration/BactDating/GPSC14/bactdating/bd_GPSC14_1e7")
res14 <- resbd$tree
resbd <- readRDS("/Users/sb62/Documents/Migration/BactDating/GPSC17/bactdating/bd_GPSC17_1e7")
res17 <- resbd$tree
resbd <- readRDS("/Users/sb62/Documents/Migration/BactDating/GPSC13/bactdating/bd_GPSC13_1e7")
res13 <- resbd$tree
resbd <- readRDS("/Users/sb62/Documents/Migration/BactDating/GPSC10/bactdating/bd_GPSC10_1e7")
res10 <- resbd$tree
resbd <- readRDS("/Users/sb62/Documents/Migration/BactDating/GPSC68/bactdating/bd_GPSC68_1e8")
res68 <- resbd$tree
resbd <- readRDS("/Users/sb62/Documents/Migration/BactDating/GPSC79/bactdating/sero4_14/bd_GPSC79_1e7")
res79 <- resbd$tree
resbd <- readRDS("/Users/sb62/Documents/Migration/BactDating/GPSC1/bactdating/bd_GPSC1_1e7")
res1 <- resbd$tree
## #Bind trees
resA <- bind.tree(res2,res5)
resB <- bind.tree(res14,res17)
resC <- bind.tree(res68, res79)
resD <- bind.tree(res10, res13)
resE <- bind.tree(resA,resB)
resF <- bind.tree(resC,resD)
resG <- bind.tree(resE, resF)
res_everything <- bind.tree(resG,res1)
lanes <- res_everything$tip.label
GPS <- read.table(file = "/Users/sb62/Documents/Migration/raw_data/combined_GPSPneumoDB_clean.csv", sep =  "," , header = TRUE, fill = TRUE, stringsAsFactors = FALSE)
GPS_GPSC_everything <- subset(GPS, GPS$Lane_Id %in% lanes)

##Input missing latitudes and longitudes
# #Latitude
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "USA"] <- 37.0902
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "China"] <- 35.8617
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "Egypt"] <- 26.8206
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "Thailand"] <- 15.87
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "The Gambia"] <- 13.4432
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "UK"] <- 3.4360

GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "Austria"] <- 47.5162
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "Germany"] <- 51.1657
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "Iceland"] <- 64.9631
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "Korea"] <- 35.9078
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "Malawi"] <- 13.2543
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "Malaysia"] <- 4.2105
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "Netherlands"] <- 52.1326
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "Portugal"] <- 39.3999
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "Taiwan"] <- 23.6978
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "Turkey"] <- 38.9637
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "Vietnam"] <- 14.0583

# #Longitude
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "USA"] <- -95.7129
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "China"] <- 104.195
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "Egypt"] <- 30.8025
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "Thailand"] <- 100.993
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "The Gambia"] <- -15.3101
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "UK"] <- 55.3781

GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "Austria"] <- 14.5501
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "Germany"] <- 10.4515
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "Iceland"] <- 19.0208
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "Korea"] <- 127.7669
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "Malawi"] <- 34.3015
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "Malaysia"] <- 101.9758
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "Netherlands"] <- 5.2913
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "Portugal"] <- 8.2245
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "Taiwan"] <- 120.9605
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "Turkey"] <- 35.2433
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "Vietnam"] <- 108.2772

### Make South African Regions match names and exclude any which do not have a geolocation by region
GPS_GPSC_everything$Region <- as.character(GPS_GPSC_everything$Region)
GPS_GPSC_everything$Region[GPS_GPSC_everything$Region == "Kwazulu Natal"] <- "KwaZulu-Natal"
GPS_GPSC_everything$Region[GPS_GPSC_everything$Region == "KwaZulu Natal"] <- "KwaZulu-Natal"
GPS_GPSC_everything$Region[GPS_GPSC_everything$Region == "Soweto"] <- "Gauteng"
GPS_GPSC_everything$Region[GPS_GPSC_everything$Region == "Agincourt"] <- "Mpumalanga"
GPS_GPSC_everything$Region[GPS_GPSC_everything$Region == "North West"] <- "North West"
GPS_GPSC_everything$Region[GPS_GPSC_everything$Country == "South Africa" & GPS_GPSC_everything$Region == ""] <- "South Africa"
#Remove genomes with no region in South Africa.
GPS_GPSC_everything <- subset(GPS_GPSC_everything, GPS_GPSC_everything$Region != "South Africa")

#### Assign latitudes and longitudes of regions
# # #Specify that North West is south africa so that it assigns the correct lat and long
GPS_GPSC_everything$Region[GPS_GPSC_everything$Region == "North West"] <- "North West, South Africa"
# # ##Province Latitude and longitude
city <- names(table(GPS_GPSC_everything$Region[GPS_GPSC_everything$Country=="South Africa"]))
#Geocoding
# #input is a list of country in a csv file
require(tmaptools)
# #output file
Geocoding_output <- data.frame("Region" =0, "Latitude_New"=0, "Longitude_New"=0)
# #Geocoding
for (i in city) {
  longitude <- geocode_OSM(i)$coords[1]
  latitude <- geocode_OSM(i)$coords[2]
  Geocoding_output <- rbind(Geocoding_output, c(i,latitude, longitude))
}
Geocoding_output <- subset(Geocoding_output, Geocoding_output$Longitude_New != 0)
GPS_GEO <- left_join(GPS_GPSC_everything, Geocoding_output, by = "Region")
# # #Change it back to the name of the province once latitude is assigned
GPS_GPSC_everything <- GPS_GEO
GPS_GPSC_everything$Region[GPS_GPSC_everything$Region == "North West, South Africa"] <- "North West"
GPS_GPSC_everything$Latitude[GPS_GPSC_everything$Country == "South Africa"] <- GPS_GPSC_everything$Latitude_New[GPS_GPSC_everything$Country == "South Africa"]
GPS_GPSC_everything$Longitude[GPS_GPSC_everything$Country == "South Africa"] <- GPS_GPSC_everything$Longitude_New[GPS_GPSC_everything$Country == "South Africa"]
GPS_GPSC_everything$Region[GPS_GPSC_everything$Country != "South Africa"] <- GPS_GPSC_everything$Country[GPS_GPSC_everything$Country != "South Africa"]

if (disease==TRUE) {GPS_GPSC_everything<-subset(GPS_GPSC_everything,GPS_GPSC_everything$Type=="Disease")}
# ###### Drop tips of tree not included in metadata
lanes_tree <- subset(lanes, lanes  %in% GPS_GPSC_everything$Lane_Id)
res_overall <- keep.tip(res_everything, lanes_tree)
# #Reorder tree based on order of tip labels
order <- res_overall$tip.label
GPS_GPSC_everything <- GPS_GPSC_everything %>%
  dplyr::slice(match(order, Lane_Id))
# setwd("/Users/sb62/Documents/Migration/Mobility_transmission_SA/Mobility_transmission/04APR22_PlotScripts/Relative_Risk_Framework/")
# save(GPS_GPSC_everything,file="GPS_GPSC_everything.RData")
# save(res_overall,file="res_overall.RData")
'%notin%'<-Negate('%in%')
# load("/Users/sb62/Documents/Migration/Mobility_transmission_SA/Mobility_transmission/04APR22_PlotScripts/Relative_Risk_Framework/GPS_GPSC_everything.RData")
published<-read.csv("/Users/sb62/Documents/Migration/SA_Migration_110422/Relative_Risk_Framework/laneids-published.csv")
# pub_lid<-published$Lane_id[which(published$Published=="Y" | published$Published=="Others")]
# GPS_GPSC_everything.pub<-subset(GPS_GPSC_everything,GPS_GPSC_everything$Lane_Id%notin%pub_lid)
# countries.included<-data.table(table(GPS_GPSC_everything$Country))[order(-N)]
# colnames(countries.included)<-c("countries","N_all")
# countries.included.pub<-data.table(table(GPS_GPSC_everything.pub$Country))[order(-N)]
# colnames(countries.included.pub)<-c("countries","N_notPub")
# countries.included<-merge(countries.included,countries.included.pub,by=c("countries"),all=TRUE)
# countries.included[which(is.na(countries.included$N_notPub)),]$N_notPub<-0
# write.csv2(countries.included,file="/Users/sb62/Documents/Migration/SA_Migration_110422/Submission/Countries_Included/countries.included.csv",quote =FALSE,row.names = FALSE)
```

##### Build Matrices of all tips in the tree 6788*6788 for all
```{r}
#### Create Matrices
## #Create Geo Matrix
vec_coords = cbind(as.numeric(GPS_GPSC_everything$Longitude), as.numeric(GPS_GPSC_everything$Latitude))
geo_mat_manyCont= geodist(
  vec_coords,
  vec_coords,
  paired=FALSE,
  measure="haversine")/1000
geo_mat_manyCont <- round(geo_mat_manyCont, 2)
diag(geo_mat_manyCont) <- NA
geo_mat_manyCont[geo_mat_manyCont==0] <- 10
colnames(geo_mat_manyCont) <-  GPS_GPSC_everything$Region
rownames(geo_mat_manyCont) <-  GPS_GPSC_everything$Region
## #Create similarity matrix
dist.mat <- cophenetic.phylo(res_overall)
diag(dist.mat) <- NA
## Create collection year matrix
lane.names <- GPS_GPSC_everything$Lane_Id
vector_colyear <- GPS_GPSC_everything$Col_time #Exact collection years
colyear_mat = abs(outer(vector_colyear, vector_colyear, "-"))
rownames(colyear_mat) <- lane.names
colnames(colyear_mat) <- lane.names
diag(colyear_mat) <- NA
strain_mat <- (dist.mat-colyear_mat)/2

## Find distances to other countries
lat_vec <- unique(as.numeric(GPS_GPSC_everything$Latitude))
lat_vec <- subset(lat_vec,!is.na(lat_vec))
long_vec <- unique(as.numeric(GPS_GPSC_everything$Longitude))
long_vec <- subset(long_vec,!is.na(long_vec))
region_vec <- unique(GPS_GPSC_everything$Region)
x <- cbind(long_vec,lat_vec)
y <- x
pairwise_distCont <- geodist(
  x,
  y,
  paired = FALSE,
  measure = "haversine") /1000
colnames(pairwise_distCont) <- region_vec
rownames(pairwise_distCont) <- region_vec
pairwise_distCont<- round(pairwise_distCont, 2)

##Create vector of pairwise distances for each continent and assign specific pairwise distances for within Africa and beyond Africa

outsideAfrica <- unique(GPS_GPSC_everything$Country[GPS_GPSC_everything$Continent != "Africa"])
outsideAfrica_distvec <- pairwise_distCont[rownames(pairwise_distCont) %in% outsideAfrica][pairwise_distCont[rownames(pairwise_distCont) %in% outsideAfrica]!=0]

outsideSouthAfrica <- unique(GPS_GPSC_everything$Country[GPS_GPSC_everything$Continent == "Africa" & GPS_GPSC_everything$Country != "South Africa"])
outsideSouthAfrica_dist_vec <-pairwise_distCont[rownames(pairwise_distCont) %in% outsideSouthAfrica][pairwise_distCont[rownames(pairwise_distCont) %in% outsideSouthAfrica]!=0]

geo_mat_manyCont[geo_mat_manyCont %in% outsideSouthAfrica_dist_vec] <- 2500
geo_mat_manyCont[geo_mat_manyCont %in% outsideAfrica_distvec] <- 6500
```
#### RR Function for divergence times and multiple countries
```{r}
neighbor_cont_bootstrap <- function(x=x,y=x, geo_matrix, colyear_matrix, strain_matrix, gpsc_matrix,denom_matrix){
  geo_mat.tmp = geo_matrix[x,y]
  time_mat.tmp = colyear_matrix[x,y]
  strain_mat.tmp = strain_matrix[x,y]
  denom_mat.tmp = denom_matrix[x,y]
  gpsc_mat.tmp = gpsc_matrix[x,y]
  
  tmp = (geo_mat.tmp) * time_mat.tmp 
  tmp[which(tmp==0)]<-NA
  
  tmp2 = (geo_mat.tmp*(geo_mat.tmp>1000)*( geo_mat.tmp<1600)) * time_mat.tmp
  tmp2[which(tmp2==0)]<-NA
  
  a1=cumsum(hist(tmp*strain_mat.tmp,breaks=c(0,0,minpos,1e10),plot=F)$counts)
  a2=cumsum(hist(tmp*strain_mat.tmp,breaks=c(0,0,maxpos,1e10),plot=F)$counts)
  a=a2-a1

  # b1=cumsum(hist(tmp*(denom_mat.tmp*gpsc_mat.tmp),breaks=c(0,0,minpos,1e10),plot=F)$counts)
  # b2=cumsum(hist(tmp*(denom_mat.tmp*gpsc_mat.tmp),breaks=c(0,0,maxpos,1e10),plot=F)$counts)
  # b=b2-b1
  
  b1=cumsum(hist(tmp*(gpsc_mat.tmp),breaks=c(0,0,minpos,1e10),plot=F)$counts)
  b2=cumsum(hist(tmp*(gpsc_mat.tmp),breaks=c(0,0,maxpos,1e10),plot=F)$counts)
  b=b2-b1
  
  c = rep(sum(tmp2*strain_mat.tmp, na.rm=T),length(b))
  
  d = rep(sum(tmp2*gpsc_mat.tmp, na.rm=T),length(a))
  # d = rep(sum(tmp2*(denom_mat.tmp)*gpsc_mat.tmp, na.rm=T),length(a))

  
  rr = (a/b)/(c/d) 
  if (max(rr, na.rm = T)>1E10){
    rr = ((a+1)/(b+1))/((c+1)/(d+1))
  }
  if (min(rr, na.rm=T)==0){
    rr = ((a+1)/(b+1))/((c+1)/(d+1)) 
  }
  rr = rr[2:(length(rr)-1)]
  return(rr)
}
```
######Run RR Calculation Categorical
```{r}
# sub==FALSE
gpscgub <- c(2,79,1,5,10,13,14,17,68)
##Extra Matrices
same_country <- outer(GPS_GPSC_everything$Country,GPS_GPSC_everything$Country,"==")
diag(same_country) <- NA
same_country = same_country+0
## GPSC
gpsc_mat <- outer(GPS_GPSC_everything$GPSC,GPS_GPSC_everything$GPSC,"==")
diag(gpsc_mat) <- NA
gpsc_mat <- gpsc_mat + 0
vector_gpsc <- GPS_GPSC_everything$GPSC
# Weight vector for sampling
weight_mat <-data.table(table(GPS_GPSC_everything$Region, GPS_GPSC_everything$GPSC))
colnames(weight_mat) <- c("Region","GPSC","N")
dataset_new <- GPS_GPSC_everything %>% left_join(weight_mat, by=c("Region","GPSC"))
weight_vector <- dataset_new$N
# #To look at different collection time ranges
tseqmax=c(5,10,20,200)
tseqmin=c(0,5,10,20)
## to look at continuously across time ranges
# tseqmax=seq(1,250,10)
# tseqmin=tseqmax-50
# tseqmin[which(tseqmin<0)] <- 0
plot_roll <- list()
mat_list <- list()
mat_plot <- list()
mat_country <-  vector(mode = "list", length = 2)
vector_region <- GPS_GPSC_everything$Region
for (k in 1:length(tseqmax)) {
    sa_row <- which(GPS_GPSC_everything$Country == "South Africa" )
    strain_matrix = (strain_mat>tseqmin[k])*(strain_mat<=tseqmax[k])
    geo_matrix = geo_mat_manyCont
    colyear_matrix = (colyear_mat>0)*(colyear_mat<=1)
    gpsc_matrix = gpsc_mat
    denom_matrix = (strain_mat>tseqmax[k])
    maxpos=c(100,500,1000,1600,c(3000,7000))
    minpos=c(0,100,500,1000,1990,4000)
    nboot=50
    boot.out = matrix(NA, length(maxpos), nboot )
    nseq = dim(colyear_matrix)[1]
    region_vec <- names(table(GPS_GPSC_everything$Region))
    for (j in 1:(nboot)){
      if (sub==TRUE){
      selectedSeqs=NULL
    for (i in 1:length(region_vec)) {
      # for (p in gpscgub) {
      a <- which(vector_region==region_vec[i] )
      b <- if (length(a) == 1) a else sample(a,min(300,length(a)),replace=F)
      selectedSeqs <- c(selectedSeqs,b)
      # }
    }
      # selectedSeqs <- sample(nseq,replace=T,prob=c(1/weight_vector))#length of number of sequences of that location with that GPSCs
      tmp = sample(selectedSeqs, replace = T)} else
      {tmp = sample(nseq,nseq, replace = T)}
      rr =neighbor_cont_bootstrap(x=sa_row,y=tmp,geo_matrix=geo_matrix, colyear_matrix=colyear_matrix, strain_matrix=strain_matrix, gpsc_matrix=gpsc_matrix,denom_matrix=denom_matrix)
      boot.out[,j] = rr
      # print(j)
    }
    boot.ci = apply(boot.out[,(1:(nboot))], 1, quantile, probs = c(0.025,0.975), na.rm = T) 
    boot.ci.m = apply(boot.out[,(1:(nboot))], 1, quantile, probs = c(0.5), na.rm = T) 
    
    mat <- matrix(nrow=length(maxpos), ncol = 6)
    ## Matrix
    mat[,1] <- paste(minpos,"-",maxpos)
    mat[,2] <- boot.ci.m
    mat[,3] <- boot.ci[1,] 
    mat[,4] <- boot.ci[2,] 
    mat[,5] <- paste(tseqmin[k],"-",tseqmax[k])
    mat[,6] <- (tseqmax[k]+tseqmin[k])/2
    
    
    colnames(mat) <- c("distance_range" , "RR", "lowerCI", "upperCI", "time_range", "medMRCA")
    mat <- as.data.table(mat)
    mat$RR <- as.numeric(mat$RR)
    mat$lowerCI <- as.numeric(mat$lowerCI)
    mat$upperCI <- as.numeric(mat$upperCI)
    mat$minimum_dist <- as.numeric(mat$minimum_dist)
    mat$medMRCA <- as.numeric(mat$medMRCA)
    mat$distance_range[mat$distance_range=="0 - 100"]<-"Within Province"
    mat$distance_range[mat$distance_range=="100 - 500"]<-"<500"
        mat$distance_range[mat$distance_range=="500 - 1000"]<-"500-1000"
    mat$distance_range[mat$distance_range=="1000 - 1600"]<-"Distant Pairs"
    mat$distance_range[mat$distance_range=="1990 - 3000"]<-"Other Africa"
    mat$distance_range[mat$distance_range=="4000 - 7000"]<-"Outside Africa"
    
    mat_list[[k]] <- mat
      print(paste0("Divergence Time:",k,"/",length(tseqmax)))
  }
  
mat_plot <- rbindlist(mat_list)
setwd("/Users/sb62/Documents/Migration/Mobility_transmission_SA/Mobility_transmission/04APR22_PlotScripts/Relative_Risk_Framework/input_files/")
matplot_specificRange <- mat_plot
# if (disease==TRUE){  if(sub==TRUE){save(matplot_specificRange,file="matplot_specificRange.disease.Sub.RData")}else{save(matplot_specificRange,file="matplot_specificRange.disease.noSub.RData")} }else { 
# if(sub==TRUE){save(matplot_specificRange,file="matplot_specificRange.Sub.RData")}else{save(matplot_specificRange,file="matplot_specificRange.noSub.RData")}}
```
#### Genomic but continuous rather than categorical
```{r}
# sub==FALSE
gpscgub <- c(2,79,1,5,10,13,14,17,68)
##Extra Matrices
same_country <- outer(GPS_GPSC_everything$Country,GPS_GPSC_everything$Country,"==")
diag(same_country) <- NA
same_country = same_country+0
## GPSC
gpsc_mat <- outer(GPS_GPSC_everything$GPSC,GPS_GPSC_everything$GPSC,"==")
diag(gpsc_mat) <- NA
gpsc_mat <- gpsc_mat + 0
vector_gpsc <- GPS_GPSC_everything$GPSC
# Weight vector for sampling
weight_mat <-data.table(table(GPS_GPSC_everything$Region, GPS_GPSC_everything$GPSC))
colnames(weight_mat) <- c("Region","GPSC","N")
dataset_new <- GPS_GPSC_everything %>% left_join(weight_mat, by=c("Region","GPSC"))
weight_vector <- dataset_new$N
# #To look at different collection time ranges
# tseqmax=c(5,10,20,200)
# tseqmin=c(0,5,10,20)
## to look at continuously across time ranges
tseqmax=seq(1,90,10)
tseqmin=tseqmax-20
tseqmin[which(tseqmin<0)] <- 0
plot_roll <- list()
mat_list <- list()
mat_plot <- list()
mat_country <-  vector(mode = "list", length = 2)
vector_region <- GPS_GPSC_everything$Region
for (k in 1:length(tseqmax)) {
    sa_row <- which(GPS_GPSC_everything$Country == "South Africa" )
    strain_matrix = (strain_mat>tseqmin[k])*(strain_mat<=tseqmax[k])
    geo_matrix = geo_mat_manyCont
    colyear_matrix = (colyear_mat>0)*(colyear_mat<=1)
    gpsc_matrix = gpsc_mat
    denom_matrix = (strain_mat>tseqmax[k])
    maxpos=c(100,500,1000,1600,c(3000,7000))
    minpos=c(0,100,500,1000,1990,4000)
    nboot=10
    boot.out = matrix(NA, length(maxpos), nboot )
    nseq = dim(colyear_matrix)[1]
    region_vec <- names(table(GPS_GPSC_everything$Region))
    for (j in 1:(nboot)){
      if (sub==TRUE){
      selectedSeqs=NULL
    for (i in 1:length(region_vec)) {
      # for (p in gpscgub) {
      a <- which(vector_region==region_vec[i] )
      b <- if (length(a) == 1) a else sample(a,min(300,length(a)),replace=F)
      selectedSeqs <- c(selectedSeqs,b)
      # }
    }
      # selectedSeqs <- sample(nseq,replace=T,prob=c(1/weight_vector))#length of number of sequences of that location with that GPSCs
      tmp = sample(selectedSeqs, replace = T)} else
      {tmp = sample(nseq,nseq, replace = T)}
      rr =neighbor_cont_bootstrap(x=sa_row,y=tmp,geo_matrix=geo_matrix, colyear_matrix=colyear_matrix, strain_matrix=strain_matrix, gpsc_matrix=gpsc_matrix,denom_matrix=denom_matrix)
      boot.out[,j] = rr
      # print(j)
    }
    boot.ci = apply(boot.out[,(1:(nboot))], 1, quantile, probs = c(0.025,0.975), na.rm = T) 
    boot.ci.m = apply(boot.out[,(1:(nboot))], 1, quantile, probs = c(0.5), na.rm = T) 
    
    mat <- matrix(nrow=length(maxpos), ncol = 7)
    ## Matrix
    mat[,1] <- paste(minpos,"-",maxpos)
    mat[,2] <- boot.ci.m
    mat[,3] <- boot.ci[1,] 
    mat[,4] <- boot.ci[2,] 
    mat[,5] <- paste(tseqmin[k],"-",tseqmax[k])
    mat[,6] <- (tseqmax[k]+tseqmin[k])/2
    mat[,7] <- minpos
    
    colnames(mat) <- c("distance_range" , "RR", "lowerCI", "upperCI", "time_range", "medMRCA","minimum_dist")
    mat <- as.data.table(mat)
    mat$RR <- as.numeric(mat$RR)
    mat$lowerCI <- as.numeric(mat$lowerCI)
    mat$upperCI <- as.numeric(mat$upperCI)
    mat$minimum_dist <- as.numeric(mat$minimum_dist)
    mat$medMRCA <- as.numeric(mat$medMRCA)
    mat$distance_range[mat$distance_range=="0 - 100"]<-"Within Province"
    mat$distance_range[mat$distance_range=="100 - 500"]<-"<500"
        mat$distance_range[mat$distance_range=="500 - 1000"]<-"500-1000"
    mat$distance_range[mat$distance_range=="1000 - 1600"]<-"Distant Pairs"
    mat$distance_range[mat$distance_range=="1990 - 3000"]<-"Other Africa"
    mat$distance_range[mat$distance_range=="4000 - 7000"]<-"Outside Africa"
    
    mat_list[[k]] <- mat
    print(paste0("Continuous DivTime:",k,"/",length(tseqmax)))
  }
  
mat_plot <- rbindlist(mat_list)
matplot_continuous <- mat_plot
# if (disease==TRUE){if(sub==TRUE){save(matplot_continuous,file="matplot_continuous.disease.Sub.RData")}else{save(matplot_continuous,file="matplot_continuous.disease.noSub.RData")}  }else{
# if(sub==TRUE){save(matplot_continuous,file="matplot_continuous.Sub.RData")}else{save(matplot_continuous,file="matplot_continuous.noSub.RData")} }
```


##### 4) RR Plot with both lineage level and divergence time level
```{r}
mat_lineage$time_range[which(mat_lineage$time_range=="0 - 1")]<-"Same Lineage"
mat.tmp <- rbind(matplot_specificRange[,c("distance_range","RR","lowerCI","upperCI","time_range")],
                 mat_lineage[,c("distance_range","RR","lowerCI","upperCI","time_range")])

mat.tmp$lowerCI[mat.tmp$lowerCI <= 0.1 ] <- 0.1
mat.tmp$upperCI[mat.tmp$upperCI <= 0.1]<- 0.1
mat.tmp$RR[mat.tmp$RR <= 0.1]<- 0.1
mat.tmp$lowerCI[mat.tmp$lowerCI >= 10 ] <- 10
mat.tmp$upperCI[mat.tmp$upperCI >= 10 ] <- 10
mat.tmp$RR[mat.tmp$RR >= 10 ] <- 10

mat.tmp$time_range_f = factor(mat.tmp$time_range, levels=c("Same Lineage", "0 - 5","5 - 10","10 - 20" ,"20 - 200"), labels = c("Same Lineage", "0 - 5","5 - 10","10 - 20" ,"20 - 200"))

lineplot <- ggplot(data = mat.tmp, aes( x = distance_range, y = RR , group = time_range_f)) +
  geom_point(size=1) +
  geom_errorbar(aes(ymin=lowerCI, ymax=upperCI), alpha = .9, color = "black", width = 0.2 ) +
  theme(panel.background = element_blank(),axis.text.x = element_text(angle = 90, size=15),axis.text.y = element_text(size=15), axis.title.y  = element_text(size=18), axis.title.x=element_text(size=18), title =element_text(size=20),
        panel.grid.major= element_line("lightgrey"), panel.grid.minor= element_line("lightgrey"),axis.line = element_line(colour = "black")) +
  scale_x_discrete(name ="Distance between isolates (km)", 
                   limits=c(mat_plot$distance_range[1:length(maxpos)]))+
    theme(aspect.ratio=14/15) +
  theme(plot.margin = unit(c(0.5, 1, 0.5, 1), "cm")) +
  ggtitle("A") +
  scale_y_continuous( trans = "log10", labels = function(x) format(x, scientific = FALSE)  ,limits=c(0.01,10)) +
    # scale_y_continuous( labels = c(0.01,) ,limits=c(0.01,10)) +
  # scale_y_continuous( trans = "log10", breaks = c(0.2,1,6),labels=c("<0.2","1.00","6.00"),limits=c(0.1,13)) +
    # scale_y_continuous( trans = "log10", breaks = c(0.2,1,6),labels=c("<0.1","1.00","6.00"),limits=c(0.19,6.2)) +

  geom_hline(yintercept=1, linetype="dashed", color = "red") +
  ylab("Risk Ratio") 

lin1_mal_cont <- lineplot + geom_rect(fill = '#00539CFF', xmin = 0, xmax = 1.5, ymin =-5, ymax = 7, alpha =0.05) +
  geom_rect(fill = '#ED2B33FF', xmin = 1.5, xmax = 3.5, ymin =-5, ymax = 7, alpha =0.05) +   
  geom_rect(fill = '#97BC62FF', xmin = 3.5, xmax = 4.5, ymin =-5, ymax = 7, alpha =0.05) +
  geom_rect(fill = 'purple', xmin = 4.5, xmax = 5.5, ymin =-5, ymax = 7, alpha =0.05) #+


pmanycont <- lin1_mal_cont + facet_wrap( ~ time_range_f, nrow =1) +
  theme(
  strip.text.x = element_text(
    size = 12, color = "black"
  ))
pmanycont 
```

```{r}

mat.tmp$time_range_f = factor(mat.tmp$time_range, levels=c("Same Lineage", "0 - 5","5 - 10","10 - 20" ,"20 - 200"), labels = c("Same Lineage", "0 - 5","5 - 10","10 - 20" ,"20 - 200"))
# matplot_specificRange$time_range_f = factor(matplot_specificRange$time_range, levels=c( "0 - 5","5 - 10","10 - 50" ,"50 - 200"  ))
mat.tmp$distance_range_f = factor(mat.tmp$distance_range, levels=c("Within Province", "<500","500-1000","Distant Pairs" ,"Other Africa","Outside Africa"))
# mat.tmp$time_range_f[which(mat.tmp$
lineplot <- ggplot(data = mat.tmp, aes( x = distance_range_f, y = RR , group = time_range_f)) +
  geom_point(size=2) +
  geom_errorbar(aes(ymin=lowerCI, ymax=upperCI), alpha = .9, color = "black", width = 0.2 ) +
  theme(axis.text.x = element_text(angle = 90, size=20),
        # axis.text.y = element_blank(), axis.title.y  = element_blank(),
        axis.text.y = element_text(size=18), axis.title.y  = element_text(size=25),
        axis.title.x=element_text(size=18), title =element_text(size=18),
        # panel.grid.major= element_line("lightgrey"), panel.grid.minor= element_line("lightgrey"),axis.line = element_line(colour = "black")) +
  panel.grid.major= element_blank(), panel.grid.minor= element_blank(),axis.line = element_line(colour = "black")) +
  
  # scale_x_discrete(name ="Distance between isolates (km)",
                   scale_x_discrete(name ="",
                                    
                   limits=c("Within Province", "<500","500-1000","Distant Pairs" ,"Other Africa","Outside Africa"))+
  theme(aspect.ratio=20/30) +
  # theme(aspect.ratio=19/15) +
  
  geom_point(aes(x=4, y=1), colour="red",size=2)+
  theme(plot.margin = unit(c(1, 1, 1, 1), "cm")) +
  scale_y_continuous( trans = "log10", breaks = c(0.01,1,10),labels=c("<0.01","1.00",">10.00"),limits=c(0.01,10)) +
  geom_hline(yintercept=1, linetype="dashed", color = "red") +
  ylab("Risk Ratio")

lin1_mal_cont <- lineplot + geom_rect(fill = '#00539CFF', xmin = 0, xmax = 1.5, ymin =-5, ymax = 7, alpha =0.05) +
  geom_rect(fill = '#ED2B33FF', xmin = 1.5, xmax = 4.5, ymin =-5, ymax = 7, alpha =0.05) +   
  geom_rect(fill = '#97BC62FF', xmin = 4.5, xmax = 5.5, ymin =-5, ymax = 7, alpha =0.05) +
  geom_rect(fill = 'purple', xmin = 5.5, xmax = 6.5, ymin =-5, ymax = 7, alpha =0.05) #+
pmanycont <- lin1_mal_cont + facet_wrap( ~ time_range_f, nrow =5) +
  # theme( strip.text.x = element_text(
    # size = 12, color = "black",font="italic"),strip.background = element_blank())+
  theme(strip.text.x=element_blank())

pmanycont
```

#### Plot Continuous
```{r}
mat_distancerange <- matplot_continuous
mat_distancerange$lowerCI[mat_distancerange$lowerCI <= 0.1 ] <- 0.1
mat_distancerange$upperCI[mat_distancerange$upperCI <= 0.1]<- 0.1
mat_distancerange$RR[mat_distancerange$RR <= 0.1]<- 0.1

mat_sub_genomic <- subset(mat_distancerange, mat_distancerange$distance_range == "Within Province" | mat_distancerange$distance_range == "500-1000" | mat_distancerange$distance_range == "Other Africa"| mat_distancerange$distance_range == "Outside Africa")
mat_sub_genomic$distance_range_f = factor(mat_sub_genomic$distance_range, levels= c("Within Province","500-1000","Other Africa","Outside Africa"))
mat_sub_genomic.tmp <- subset(mat_distancerange, mat_distancerange$distance_range=="Within Province")
plotwithin <- ggplot(data = mat_sub_genomic, aes( x = medMRCA, y = RR, group = distance_range_f ,color = distance_range_f)) + 
  geom_line()+
  geom_ribbon(aes(ymin=lowerCI, ymax=upperCI), alpha = 0.1, color = NA, fill = "#00539CFF" ) +
  theme(axis.text.x = element_text(angle = 90, size=15),
        axis.text.y = element_text(size=15),
        axis.title.x = element_text(size=18),
        axis.title.y = element_text(size=18),
        title = element_text(size=20)) +
  # ggtitle("B")+
  # scale_x_discrete(name ="Distance between isolates (km)",
                   # limits=c(matbind$distance_range[1:4]))+
  # scale_y_log10(labels = function(x) format(x, scientific = FALSE))+
    scale_y_continuous( trans = "log10", breaks = c(0.10,1,6),labels=c("<0.1","1.00",">6.00"),limits=c(0.1,6)) +
    # scale_y_continuous( trans = "log10", breaks = c(0.2,1,6),labels=c("<0.2","1.00",">6.00"),limits=c(0.19,6.2)) +

  geom_hline(yintercept=1, linetype="dashed", color = "red") +
  ylab("Risk Ratio") + 
  xlab("tMRCA (years)")+
  theme(aspect.ratio=14/15) +
  scale_color_manual(limits = c("Within Province","500-1000","Other Africa","Outside Africa"), values = c('#00539CFF','#ED2B33FF','#97BC62FF','purple')) + 
  theme(panel.grid.major =  element_line(colour="lightgrey", size=0.1), panel.grid.minor =  element_line(colour="lightgrey", size=0.1),
        panel.background = element_blank(), axis.line = element_line(colour = "black"),
        legend.position = "none") +
  theme(axis.text.y = element_text(size= 15) ) +
  xlim(0,100)
homog <- plotwithin + facet_wrap( ~ distance_range_f, nrow =1) +
  theme(strip.text.x = element_blank())
```

#####Test only under 5's


